- name: Deploy Mini Shop API to k3s (local)
  hosts: localhost
  become: true

  vars:
    project_dir: "{{ lookup('env','HOME') }}/mini-shop-api"

  tasks:
    - name: Install required packages
      apt:
        name:
          - curl
          - ca-certificates
        state: present
        update_cache: yes

    - name: Install k3s if missing
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--write-kubeconfig-mode 644" sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Wait for node to be Ready
      shell: |
        for i in {1..60}; do
          k3s kubectl get nodes | grep -q " Ready " && exit 0
          sleep 2
        done
        exit 1

    - name: Apply Kubernetes manifests
      shell: |
        k3s kubectl apply -f {{ project_dir }}/k8s
