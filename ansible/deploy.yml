---
- name: Deploy Mini Shop API to k3s
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    kubeconfig_src: /etc/rancher/k3s/k3s.yaml
    kubeconfig_dst: "{{ lookup('env','HOME') + '/.kube/config' }}"
    manifests_dir: "{{ playbook_dir }}/../k8s"

  tasks:
    - name: Ensure ~/.kube exists
      file:
        path: "{{ lookup('env','HOME') + '/.kube' }}"
        state: directory
        mode: "0700"

    - name: Copy kubeconfig from k3s (needs sudo)
      become: true
      copy:
        src: "{{ kubeconfig_src }}"
        dest: "{{ kubeconfig_dst }}"
        remote_src: true
        owner: "{{ lookup('env','USER') }}"
        group: "{{ lookup('env','USER') }}"
        mode: "0600"

    - name: Apply Kubernetes manifests
      environment:
        KUBECONFIG: "{{ kubeconfig_dst }}"
      command: kubectl apply -f "{{ manifests_dir }}"

    - name: Restart deployment to pull latest image
      environment:
        KUBECONFIG: "{{ kubeconfig_dst }}"
      command: kubectl rollout restart deployment/mini-shop-deploy

    - name: Wait for rollout
      environment:
        KUBECONFIG: "{{ kubeconfig_dst }}"
      command: kubectl rollout status deployment/mini-shop-deploy --timeout=120s
